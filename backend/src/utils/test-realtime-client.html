<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCMS Real-time Test Client</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .events { background: #f5f5f5; padding: 15px; border-radius: 8px; height: 500px; overflow-y: auto; }
        .event { margin: 8px 0; padding: 12px; background: white; border-radius: 5px; border-left: 4px solid #007bff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .event.image { border-left-color: #28a745; }
        .event.user { border-left-color: #ffc107; }
        .event.system { border-left-color: #dc3545; }
        .event-header { font-weight: bold; margin-bottom: 8px; color: #333; }
        .event-details { background: #f8f9fa; padding: 8px; border-radius: 3px; margin-top: 8px; font-size: 12px; }
        .file-link { color: #007bff; text-decoration: none; font-weight: bold; padding: 4px 8px; background: #e3f2fd; border-radius: 3px; }
        .file-link:hover { text-decoration: underline; background: #bbdefb; }
        .event-meta { color: #6c757d; font-size: 11px; margin-top: 5px; }
        .controls { margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        input { flex: 1; max-width: 300px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 12px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .stats { display: flex; gap: 20px; margin: 15px 0; }
        .stat { background: white; padding: 15px; border-radius: 5px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 12px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ JCMS Real-time Test Client</h1>
            <p>Monitor live WebSocket events for image operations, user activities, and system updates.</p>
            
            <div id="status" class="status disconnected">
                ‚ùå Disconnected from server
            </div>

            <div class="controls">
                <input type="text" id="tenantId" placeholder="Enter Tenant ID to join room" />
                <button onclick="joinTenant()">Join Tenant Room</button>
                <button onclick="clearEvents()">Clear Events</button>
                <button onclick="toggleAutoScroll()">Auto-scroll: ON</button>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="eventCount">0</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="imageEvents">0</div>
                    <div class="stat-label">Image Events</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="connectedTime">00:00</div>
                    <div class="stat-label">Connected Time</div>
                </div>
            </div>
        </div>

        <h3>üì° Live Events Stream</h3>
        <div id="events" class="events">
            <div class="event system">
                <div class="event-header">üîÑ Waiting for events...</div>
                <div class="event-meta">Connect to server and join a tenant room to see live updates</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:5000');
        const eventsDiv = document.getElementById('events');
        const statusDiv = document.getElementById('status');
        
        let eventCount = 0;
        let imageEventCount = 0;
        let autoScroll = true;
        let connectTime = null;

        // Connection status
        socket.on('connect', () => {
            statusDiv.className = 'status connected';
            statusDiv.innerHTML = '‚úÖ Connected to JCMS server';
            connectTime = new Date();
            addEvent('system', 'Connected to JCMS WebSocket server', 'success');
            startTimer();
        });

        socket.on('disconnect', () => {
            statusDiv.className = 'status disconnected';
            statusDiv.innerHTML = '‚ùå Disconnected from server';
            addEvent('system', 'Disconnected from server', 'error');
        });

        // Image events
        socket.on('image:uploaded', (data) => {
            addImageEvent('üì∏', data.message, data, 'uploaded');
            imageEventCount++;
            updateStats();
        });

        socket.on('image:updated', (data) => {
            addImageEvent('‚úèÔ∏è', data.message, data, 'updated');
            imageEventCount++;
            updateStats();
        });

        socket.on('image:deleted', (data) => {
            addImageEvent('üóëÔ∏è', data.message, data, 'deleted');
            imageEventCount++;
            updateStats();
        });

        // User events
        socket.on('user:registered', (data) => {
            addEvent('user', `üë§ ${data.message}`, 'info', data);
        });

        // Analytics events
        socket.on('analytics:update', (data) => {
            addEvent('system', `üìä Analytics dashboard updated`, 'info', data);
        });

        // System events
        socket.on('system:alert', (data) => {
            addEvent('system', `üö® ${data.message}`, data.level, data);
        });

        function addEvent(type, message, level, data = null) {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type}`;
            
            const time = new Date().toLocaleTimeString();
            eventDiv.innerHTML = `
                <div class="event-header">[${time}] ${message}</div>
                ${data ? `<div class="event-details">Data: ${JSON.stringify(data, null, 2)}</div>` : ''}
            `;
            
            eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);
            eventCount++;
            updateStats();
            
            if (autoScroll) {
                eventsDiv.scrollTop = 0;
            }
            
            // Keep only last 100 events
            while (eventsDiv.children.length > 100) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        function addImageEvent(icon, message, data, action) {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event image';
            
            const time = new Date().toLocaleTimeString();
            const user = data.user;
            
            // Handle different data structures for delete vs upload/update
            let image, imageId;
            if (action === 'deleted') {
                image = { id: data.imageId, title: data.message.match(/"([^"]+)"/)?.[1] || 'Unknown' };
                imageId = data.imageId;
            } else {
                image = data.image;
                imageId = image.id;
            }
            
            let actionDetails = '';
            if (action !== 'deleted' && image.fileUrl) {
                actionDetails = `
                    <div style="margin: 8px 0;">
                        <strong>File:</strong> 
                        <a href="${image.fileUrl}" target="_blank" class="file-link">
                            üñºÔ∏è View Image
                        </a>
                        <span style="margin-left: 10px; color: #6c757d;">(${image.format?.toUpperCase()})</span>
                    </div>
                `;
            } else if (action === 'deleted') {
                actionDetails = `
                    <div style="margin: 8px 0; color: #dc3545;">
                        <strong>üóëÔ∏è File deleted from server</strong>
                    </div>
                `;
            }
            
            eventDiv.innerHTML = `
                <div class="event-header">
                    ${icon} [${time}] ${message}
                </div>
                ${actionDetails}
                <div class="event-meta">
                    User: ${user.username} | Image ID: ${imageId}
                </div>
                <div class="event-details">
                    <strong>Full Event Data:</strong><br>
                    <pre style="margin: 5px 0; font-size: 10px;">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            
            eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);
            eventCount++;
            
            if (autoScroll) {
                eventsDiv.scrollTop = 0;
            }
            
            // Keep only last 100 events
            while (eventsDiv.children.length > 100) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        function joinTenant() {
            const tenantId = document.getElementById('tenantId').value;
            if (tenantId) {
                socket.emit('join-tenant', tenantId);
                addEvent('system', `Joined tenant room: ${tenantId}`, 'info');
            } else {
                alert('Please enter a tenant ID');
            }
        }

        function clearEvents() {
            eventsDiv.innerHTML = '<div class="event system"><div class="event-header">üßπ Events cleared</div></div>';
            eventCount = 0;
            imageEventCount = 0;
            updateStats();
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const button = event.target;
            button.textContent = `Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
            button.style.background = autoScroll ? '#007bff' : '#6c757d';
        }

        function updateStats() {
            document.getElementById('eventCount').textContent = eventCount;
            document.getElementById('imageEvents').textContent = imageEventCount;
        }

        function startTimer() {
            setInterval(() => {
                if (connectTime) {
                    const elapsed = Math.floor((new Date() - connectTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('connectedTime').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
    </script>
</body>
</html>