<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCMS Admin Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 900px; margin: 0 auto; }
        .notification { 
            background: #ffffff; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .notification:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .timestamp { color: #6c757d; font-size: 0.85em; margin-bottom: 8px; }
        .action { font-weight: bold; color: #007bff; }
        .user { color: #28a745; font-weight: 600; }
        .resource { color: #dc3545; font-weight: 500; }
        #status { padding: 12px; margin: 15px 0; border-radius: 8px; font-weight: 600; text-align: center; }
        .connected { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .tabs { display: flex; gap: 8px; margin: 10px 0; }
        .tab-btn { padding: 8px 12px; border: 1px solid #dee2e6; background: #f1f3f5; border-radius: 6px; cursor: pointer; }
        .tab-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .login-form { 
            background: #ffffff; 
            padding: 25px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .login-form input { 
            margin: 8px; 
            padding: 12px; 
            width: 250px; 
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        .login-form input:focus { 
            outline: none; 
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 5px;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        #notifications { 
            max-height: 600px; 
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            background: #ffffff;
        }
        #notifications::-webkit-scrollbar { width: 8px; }
        #notifications::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #notifications::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        #notifications::-webkit-scrollbar-thumb:hover { background: #555; }
        .controls { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .notification-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
        }
        .aggregated-notification {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .aggregated-notification .timestamp { color: #e9ecef; }
    </style>
</head>
<body>
    <div class="container">
        <h1>JCMS Admin Dashboard</h1>
        
        <div class="login-form">
            <h3>üîê Admin Login</h3>
            <div>
                <input type="text" id="username" placeholder="Username" value="superadmin">
                <input type="password" id="password" placeholder="Password" value="admin123">
                <button class="btn btn-primary" onclick="login()" id="connectBtn">üîå Connect</button>
            </div>
            
            <div class="controls">
                <strong>‚öôÔ∏è Notification Settings:</strong><br>
                <div style="margin-top: 10px;">
                    <button class="btn btn-secondary" id="soundToggle" onclick="toggleSound()">üîä Sound: ON</button>
                    <button class="btn btn-warning" onclick="toggleQuietMode()" id="quietToggle">üîá Quiet Mode: OFF</button>
                    <button class="btn btn-secondary" onclick="clearNotifications()">üóëÔ∏è Clear Feed</button>
                    <button class="btn btn-success" onclick="toggleAggregation()" id="aggregationToggle">üìä Aggregation: ON</button>
                </div>
            </div>
        </div>

        <div id="status" class="disconnected">‚ùå Disconnected</div>
        
        <div class="notification-header">
            <h3>üìà Activity</h3>
            <div>
                <span id="notificationCount">0 notifications</span>
                <span id="aggregationStatus" style="margin-left: 15px; font-size: 0.9em; color: #6c757d;"></span>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" id="tab-live" onclick="switchTab('live')">Live Feed</button>
            <button class="tab-btn" id="tab-high" onclick="switchTab('high')">High Activity</button>
            <button class="tab-btn" id="tab-agg" onclick="switchTab('agg')">Aggregates</button>
        </div>
        <div id="panel-live" class="tab-panel active">
            <div id="notifications"></div>
        </div>
        <div id="panel-high" class="tab-panel">
            <div id="high-activity-list" style="border: 2px solid #dee2e6; border-radius: 10px; padding: 10px; background: #fff;"></div>
        </div>
        <div id="panel-agg" class="tab-panel">
            <div id="aggregates-list" style="border: 2px solid #dee2e6; border-radius: 10px; padding: 10px; background: #fff;"></div>
        </div>
    </div>

    <script>
        let socket;
        let token;
        let originalTitle = document.title;
        let originalFavicon = null;
        let blinkInterval;
        let faviconInterval;
        let isBlinking = false;
        
        // Store original favicon
        const faviconLink = document.querySelector('link[rel="icon"]') || document.createElement('link');
        faviconLink.rel = 'icon';
        if (!document.querySelector('link[rel="icon"]')) {
            document.head.appendChild(faviconLink);
        }
        originalFavicon = faviconLink.href;

        // Request notification permission on page load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        function createAlertFavicon() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            // Red circle
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(16, 16, 15, 0, 2 * Math.PI);
            ctx.fill();
            
            // White exclamation mark
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('!', 16, 22);
            
            return canvas.toDataURL();
        }
        
        function blinkTab(priority = 'low') {
            if (isBlinking) return;
            // Only blink for critical or high priority notifications
            if (priority !== 'critical' && priority !== 'high') return;
            isBlinking = true;
            let count = 0;
            const maxBlinks = priority === 'critical' ? 10 : 4; // Less blinking
            
            // Gentler title change
            blinkInterval = setInterval(() => {
                document.title = count % 2 === 0 ? 'üìä JCMS Activity' : originalTitle;
                count++;
                
                if (count >= maxBlinks) {
                    clearInterval(blinkInterval);
                    document.title = originalTitle;
                    isBlinking = false;
                }
            }, 1000); // Slower, less aggressive blinking
        }

        function showDesktopNotification(notification, priority = 'low') {
            // Only show desktop notifications for high priority or critical events
            if (priority !== 'critical' && priority !== 'high') return;
            
            if ('Notification' in window && Notification.permission === 'granted') {
                const { action, data } = notification;
                
                // Less aggressive notification
                new Notification(`JCMS: ${priority === 'critical' ? 'Critical' : 'Important'} Activity`, {
                    body: `${data.username} - ${action}`,
                    icon: '/favicon.ico',
                    tag: 'jcms-activity',
                    requireInteraction: priority === 'critical' // Only require interaction for critical
                });
            }
        }

        let soundEnabled = localStorage.getItem('jcms-sound-enabled') !== 'false';
        let aggregationEnabled = localStorage.getItem('jcms-aggregation-enabled') !== 'false';
        let notificationBucket = new Map();
        let aggregationThreshold = 5; // Aggregate after 5 similar notifications
        let aggregationWindow = 300000; // 5 minutes window
        let totalNotifications = 0;
        
        function playNotificationSound(priority = 'low') {
            // Play sound for high and critical if enabled
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                // Different tone/volume by priority
                if (priority === 'critical') {
                    oscillator.frequency.setValueAtTime(700, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                } else if (priority === 'high') {
                    oscillator.frequency.setValueAtTime(520, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.25);
                }
            } catch (e) { /* ignore */ }
        }
        
        function toggleSound() {
            console.log('Sound toggle clicked');
            try {
                soundEnabled = !soundEnabled;
                localStorage.setItem('jcms-sound-enabled', soundEnabled);
                const btn = document.getElementById('soundToggle');
                if (btn) {
                    btn.textContent = `Sound: ${soundEnabled ? 'ON' : 'OFF'}`;
                    console.log('Sound toggled to:', soundEnabled);
                } else {
                    console.error('Sound toggle button not found');
                }
            } catch (error) {
                console.error('Error toggling sound:', error);
            }
        }
        
        function getPriority(action) {
            const critical = ['security_event', 'system_alert', 'user_delete', 'admin_login_failure'];
            const high = ['user_create', 'role_change', 'tenant_create', 'high_activity_alert'];
            const medium = ['user_update', 'image_delete', 'bulk_operation'];
            
            if (critical.includes(action)) return 'critical';
            if (high.includes(action)) return 'high';
            if (medium.includes(action)) return 'medium';
            return 'low';
        }
        
        let quietMode = localStorage.getItem('jcms-quiet-mode') === 'true';
        
        function toggleQuietMode() {
            console.log('Quiet mode toggle clicked');
            try {
                quietMode = !quietMode;
                localStorage.setItem('jcms-quiet-mode', quietMode);
                const btn = document.getElementById('quietToggle');
                if (btn) {
                    btn.textContent = `Quiet Mode: ${quietMode ? 'ON' : 'OFF'}`;
                    console.log('Quiet mode toggled to:', quietMode);
                } else {
                    console.error('Quiet mode toggle button not found');
                }
            } catch (error) {
                console.error('Error toggling quiet mode:', error);
            }
        }
        
        function clearNotifications() {
            console.log('Clear notifications clicked');
            try {
                const container = document.getElementById('notifications');
                if (container) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Notifications cleared</div>';
                    notificationBucket.clear();
                    totalNotifications = 0;
                    updateNotificationCount();
                    console.log('Notifications cleared');
                } else {
                    console.error('Notifications container not found');
                }
            } catch (error) {
                console.error('Error clearing notifications:', error);
            }
        }
        
        function toggleAggregation() {
            console.log('Aggregation toggle clicked');
            try {
                aggregationEnabled = !aggregationEnabled;
                localStorage.setItem('jcms-aggregation-enabled', aggregationEnabled);
                const btn = document.getElementById('aggregationToggle');
                if (btn) {
                    btn.textContent = `üìä Aggregation: ${aggregationEnabled ? 'ON' : 'OFF'}`;
                    console.log('Aggregation toggled to:', aggregationEnabled);
                } else {
                    console.error('Aggregation toggle button not found');
                }
                updateAggregationStatus();
            } catch (error) {
                console.error('Error toggling aggregation:', error);
            }
        }
        
        function updateNotificationCount() {
            const countEl = document.getElementById('notificationCount');
            if (countEl) {
                countEl.textContent = `${totalNotifications} notifications`;
            }
        }
        
        // Tabs handling
        let currentTab = 'live';
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-live').classList.toggle('active', tab === 'live');
            document.getElementById('tab-high').classList.toggle('active', tab === 'high');
            document.getElementById('panel-live').classList.toggle('active', tab === 'live');
            document.getElementById('panel-high').classList.toggle('active', tab === 'high');
            document.getElementById('panel-agg').classList.toggle('active', tab === 'agg');
            document.getElementById('tab-agg').classList.toggle('active', tab === 'agg');
        }
        
        function updateAggregationStatus() {
            const statusEl = document.getElementById('aggregationStatus');
            if (statusEl) {
                if (aggregationEnabled) {
                    const bucketCount = notificationBucket.size;
                    statusEl.textContent = bucketCount > 0 ? `${bucketCount} active buckets` : 'Aggregation active';
                } else {
                    statusEl.textContent = 'Individual notifications';
                }
            }
        }
        
        function getBucketKey(action, username, resource) {
            return `${action}:${username}:${resource}`;
        }
        
        function cleanOldBuckets() {
            const now = Date.now();
            for (let [key, bucket] of notificationBucket.entries()) {
                if (now - bucket.lastUpdate > aggregationWindow) {
                    notificationBucket.delete(key);
                }
            }
            updateAggregationStatus();
        }
        
        // Initialize UI on load
        window.addEventListener('load', () => {
            console.log('Page loaded, initializing UI...');
            try {
                const soundToggle = document.getElementById('soundToggle');
                const quietToggle = document.getElementById('quietToggle');
                const aggregationToggle = document.getElementById('aggregationToggle');
                
                if (soundToggle) {
                    soundToggle.textContent = `üîä Sound: ${soundEnabled ? 'ON' : 'OFF'}`;
                    console.log('Sound toggle initialized');
                } else {
                    console.error('Sound toggle button not found during initialization');
                }
                
                if (quietToggle) {
                    quietToggle.textContent = `üîá Quiet Mode: ${quietMode ? 'ON' : 'OFF'}`;
                    console.log('Quiet toggle initialized');
                } else {
                    console.error('Quiet toggle button not found during initialization');
                }
                
                if (aggregationToggle) {
                    aggregationToggle.textContent = `üìä Aggregation: ${aggregationEnabled ? 'ON' : 'OFF'}`;
                    console.log('Aggregation toggle initialized');
                } else {
                    console.error('Aggregation toggle button not found during initialization');
                }
                
                // Test if buttons are clickable
                console.log('Testing button event listeners...');
                const connectBtn = document.querySelector('button[onclick="login()"]');
                if (connectBtn) {
                    console.log('Connect button found and should be functional');
                } else {
                    console.error('Connect button not found');
                }
                
                console.log('UI initialization completed');
            } catch (error) {
                console.error('Error during UI initialization:', error);
            }
        });
        
        // Also initialize on DOMContentLoaded as backup
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, double-checking initialization...');
            const soundToggle = document.getElementById('soundToggle');
            const quietToggle = document.getElementById('quietToggle');
            const aggregationToggle = document.getElementById('aggregationToggle');
            
            if (soundToggle && !soundToggle.textContent.includes(':')) {
                soundToggle.textContent = `üîä Sound: ${soundEnabled ? 'ON' : 'OFF'}`;
            }
            
            if (quietToggle && !quietToggle.textContent.includes(':')) {
                quietToggle.textContent = `üîá Quiet Mode: ${quietMode ? 'ON' : 'OFF'}`;
            }
            
            if (aggregationToggle && !aggregationToggle.textContent.includes(':')) {
                aggregationToggle.textContent = `üìä Aggregation: ${aggregationEnabled ? 'ON' : 'OFF'}`;
            }
            
            updateNotificationCount();
            updateAggregationStatus();
        });

        // Stop blinking when user focuses on tab
        window.addEventListener('focus', () => {
            if (isBlinking) {
                clearInterval(blinkInterval);
                clearInterval(faviconInterval);
                document.title = originalTitle;
                faviconLink.href = originalFavicon;
                isBlinking = false;
            }
        });
        
        // Also stop on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isBlinking) {
                clearInterval(blinkInterval);
                clearInterval(faviconInterval);
                document.title = originalTitle;
                faviconLink.href = originalFavicon;
                isBlinking = false;
            }
        });

        async function login() {
            console.log('üîå Login button clicked - connecting directly to WebSocket...');
            
            // For testing, connect directly without authentication
            // In production, you'd want to validate credentials first
            connectSocket();
            
            // Optional: Also perform login for API access
            try {
                const usernameEl = document.getElementById('username');
                const passwordEl = document.getElementById('password');
                
                if (usernameEl && passwordEl && usernameEl.value && passwordEl.value) {
                    console.log('üîê Also performing API login...');
                    const baseUrl = getBaseUrl();
                    const response = await fetch(baseUrl + '/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: usernameEl.value, 
                            password: passwordEl.value 
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        token = data.token;
                        console.log('‚úÖ API login successful');
                    } else {
                        console.log('‚ö†Ô∏è API login failed, but WebSocket should still work');
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è API login error, but WebSocket should still work:', error.message);
            }
        }

        async function ensureSocketIoLoaded(baseUrl) {
            if (typeof io !== 'undefined') return;
            await new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = `${baseUrl}/socket.io/socket.io.js`;
                s.onload = resolve;
                s.onerror = () => {
                    const cdn = document.createElement('script');
                    cdn.src = 'https://cdn.socket.io/4.8.1/socket.io.min.js';
                    cdn.onload = resolve;
                    cdn.onerror = reject;
                    document.head.appendChild(cdn);
                };
                document.head.appendChild(s);
            });
        }

        function getBaseUrl() {
            if (location.protocol.startsWith('http')) return location.origin;
            return 'http://localhost:5000';
        }

        async function connectSocket() {
            console.log('üîå Attempting to connect socket...');
            try {
                const baseUrl = getBaseUrl();
                await ensureSocketIoLoaded(baseUrl);
                socket = io(baseUrl, {
                    timeout: 10000,
                    forceNew: true,
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    console.log('‚úÖ Socket connected successfully - ID:', socket.id);
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                        statusEl.textContent = '‚úÖ Connected as Admin (ID: ' + socket.id + ')';
                        statusEl.className = 'connected';
                    }
                });

                socket.on('disconnect', (reason) => {
                    console.log('Socket disconnected:', reason);
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                        statusEl.textContent = 'Disconnected (' + reason + ')';
                        statusEl.className = 'disconnected';
                    }
                });

                socket.on('admin_notification', (notification) => {
                    console.log('üîä ADMIN NOTIFICATION RECEIVED:', notification);
                    console.log('Action:', notification.action, 'User:', notification.data?.username, 'Message:', notification.message);
                    addNotification(notification);
                });

                // Receive server-side aggregates
                socket.on('aggregated_notification', (notification) => {
                    console.log('üì¶ AGGREGATED NOTIFICATION:', notification);
                    // Only render regular aggregated notifications here
                    if (!notification.data?.dayFormatted) {
                        renderAggregate(notification);
                    }
                });
                
                // Handle time bucket notifications
                socket.on('time_bucket_hourly', (notification) => {
                    console.log('‚è±Ô∏è HOURLY TIME BUCKET (ignored in Live tab):', notification);
                    // Suppress hourly summaries in the live feed to avoid duplication
                    // If desired, we could render these in the Aggregates tab instead.
                });
                
                socket.on('time_bucket_daily', (notification) => {
                    console.log('üìÖ DAILY TIME BUCKET:', notification);
                    processTimeBucketNotification(notification, 'daily');
                });

                socket.on('connect_error', (error) => {
                    console.error('Socket connection error:', error);
                    const statusEl = document.getElementById('status');
                    if (statusEl) {
                        statusEl.textContent = 'Connection Error: ' + error.message;
                        statusEl.className = 'disconnected';
                    }
                });
                
                // Test notification button
                setTimeout(() => {
                    try {
                        const container = document.querySelector('.container');
                        if (container) {
                            const testBtn = document.createElement('button');
                            testBtn.textContent = 'Send Test Notification';
                            testBtn.style.cssText = 'margin: 10px 0; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;';
                            testBtn.onclick = () => {
                                console.log('Test notification button clicked');
                                const baseUrl = getBaseUrl();
                                fetch(baseUrl + '/api/test-notification', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': token ? `Bearer ${token}` : ''
                                    },
                                    body: JSON.stringify({ test: 'admin-dashboard' })
                                }).then(response => {
                                    console.log('Test notification response:', response.status);
                                }).catch(error => {
                                    console.error('Test notification error:', error);
                                });
                            };
                            container.appendChild(testBtn);
                        }
                    } catch (error) {
                        console.error('Error creating test button:', error);
                    }
                }, 1000);
            } catch (error) {
                console.error('Error initializing socket:', error);
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.textContent = 'Socket initialization failed';
                    statusEl.className = 'disconnected';
                }
            }
        }

        function addNotification(notification) {
            console.log('üîî RECEIVED NOTIFICATION:', notification);
            const { action, data, timestamp, message } = notification;
            // Suppress time-bucket notifications in the live feed
            if (action && action.startsWith('time_bucket_')) return;
            const priority = getPriority(action);
            totalNotifications++;
            updateNotificationCount();
            // If high-activity alert, also push to dedicated tab
            if (action === 'high_activity_alert') {
                renderHighActivity(notification);
            }
            const container = document.getElementById('notifications');
            const div = document.createElement('div');
            div.className = 'notification';
            
            // Add priority styling
            if (priority === 'critical') {
                div.style.borderLeft = '4px solid #dc3545';
                div.style.background = '#fff5f5';
            } else if (priority === 'high') {
                div.style.borderLeft = '4px solid #ffc107';
                div.style.background = '#fffbf0';
            }
            
            // Handle high activity alerts
            if (action === 'high_activity_alert') {
                div.innerHTML = `
                    <div class="timestamp">${new Date(timestamp).toLocaleString()}</div>
                    <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 10px; border-radius: 5px;">
                        <strong>‚ö†Ô∏è High Activity Alert</strong>
                        <div style="margin-top: 5px;">
                            <strong>${data.username}</strong> performed <strong>${data.totalOperations}</strong> operations in ${data.timeframe}
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            ${Object.values(data.summary).map(s => 
                                `<div>‚Ä¢ ${s.count}x ${s.action} on ${s.resource}</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Regular notification
                div.innerHTML = `
                    <div class="timestamp">${new Date(timestamp).toLocaleString()}</div>
                    <div>
                        <span class="user">${data?.username || 'Unknown'}</span> 
                        performed <span class="action">${action || 'action'}</span> 
                        on <span class="resource">${data?.resource || 'resource'}</span>
                        ${data?.resourceId ? `(ID: ${data.resourceId})` : ''}
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        Role: ${data?.userRole || 'N/A'} | IP: ${data?.details?.ip || 'N/A'}
                    </div>
                    <div style="font-size: 0.9em; margin-top: 5px;">${message || 'No message'}</div>
                `;
            }
            
            container.insertBefore(div, container.firstChild);
            
            // Keep only last 20 notifications
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
            
            // Only trigger intrusive alerts when not focused
            if (document.hidden || !document.hasFocus()) {
                blinkTab(priority);
                showDesktopNotification(notification, priority);
                playNotificationSound(priority);
            }
            // But always draw attention for high-activity alerts
            if (action === 'high_activity_alert') {
                blinkTab('high');
                playNotificationSound('high');
                showDesktopNotification(notification, 'high');
            }
        }
        
        function shouldAggregate(notification) {
            const { action, data } = notification;
            // Don't aggregate critical notifications
            if (getPriority(action) === 'critical') {
                return false;
            }
            // Only aggregate similar operations by same user on same resource type
            return ['user_update', 'image_upload', 'image_delete', 'file_upload'].includes(action);
        }
        
        function handleAggregation(notification) {
            const { action, data, timestamp } = notification;
            const bucketKey = getBucketKey(action, data.username, data.resource);
            const now = Date.now();
            
            if (notificationBucket.has(bucketKey)) {
                const bucket = notificationBucket.get(bucketKey);
                bucket.count++;
                bucket.lastUpdate = now;
                bucket.notifications.push(notification);
                
                if (bucket.count >= aggregationThreshold) {
                    displayAggregatedNotification(bucket);
                    notificationBucket.delete(bucketKey);
                } else {
                    updateExistingBucket(bucketKey, bucket);
                }
            } else {
                // Create new bucket
                notificationBucket.set(bucketKey, {
                    action,
                    username: data.username,
                    resource: data.resource,
                    count: 1,
                    firstSeen: now,
                    lastUpdate: now,
                    notifications: [notification],
                    displayed: false
                });
                
                // Show individual notification for first occurrence
                displayIndividualNotification(notification);
            }
            
            updateAggregationStatus();
        }
        
        function displayAggregatedNotification(bucket) {
            const container = document.getElementById('notifications');
            const div = document.createElement('div');
            div.className = 'notification aggregated-notification';
            
            const timeSpan = Math.round((bucket.lastUpdate - bucket.firstSeen) / 1000 / 60);
            
            div.innerHTML = `
                <div class="timestamp">üìà Aggregated ‚Ä¢ ${new Date(bucket.lastUpdate).toLocaleString()}</div>
                <div style="font-size: 1.1em; margin: 10px 0;">
                    <strong>üìã ${bucket.count} ${bucket.action} operations</strong>
                </div>
                <div style="margin: 8px 0;">
                    üë§ User: <strong>${bucket.username}</strong> ‚Ä¢ 
                    üìÅ Resource: <strong>${bucket.resource}</strong>
                </div>
                <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.9;">
                    ‚è±Ô∏è Time span: ${timeSpan} minutes ‚Ä¢ 
                    <button onclick="expandAggregation(this)" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">Show Details</button>
                </div>
                <div class="aggregated-details" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                    ${bucket.notifications.map((n, i) => 
                        `<div style="margin: 3px 0; font-size: 0.85em;">${i+1}. ${new Date(n.timestamp).toLocaleTimeString()} - ${n.data.resourceId || 'N/A'}</div>`
                    ).join('')}
                </div>
            `;
            
            container.insertBefore(div, container.firstChild);
            
            // Keep only last 15 notifications (to account for aggregated ones taking more space)
            while (container.children.length > 15) {
                container.removeChild(container.lastChild);
            }
        }
        
        function updateExistingBucket(bucketKey, bucket) {
            // Find existing bucket notification in DOM and update count if needed
            // For now, we'll just wait until threshold is reached
            console.log(`Bucket ${bucketKey} now has ${bucket.count} notifications`);
        }
        
        function expandAggregation(buttonEl) {
            const details = buttonEl.parentElement.parentElement.querySelector('.aggregated-details');
            if (details) {
                const isVisible = details.style.display !== 'none';
                details.style.display = isVisible ? 'none' : 'block';
                buttonEl.textContent = isVisible ? 'Show Details' : 'Hide Details';
            }
        }
        
        function processTimeBucketNotification(notification, bucketType) {
            const { action, data, timestamp, message } = notification;
            // For daily notifications, render in aggregates tab
            if (bucketType === 'daily') {
                renderAggregate(notification);
                return;
            }
            const container = document.getElementById('notifications');
            const div = document.createElement('div');
            div.className = 'notification time-bucket-notification';
            
            // Style based on bucket type
            if (bucketType === 'hourly') {
                div.style.borderLeft = '4px solid #17a2b8'; // Info blue
                div.style.background = '#f0f8ff';
            } else if (bucketType === 'daily') {
                div.style.borderLeft = '4px solid #6f42c1'; // Purple
                div.style.background = '#f8f5ff';
            }
            
            // Create content based on bucket type
            if (bucketType === 'hourly') {
                const { originalAction, hourFormatted, totalOperations, users, resources, activityRate, activityDuration, operationBreakdown } = data;
                
                div.innerHTML = `
                    <div class="timestamp">‚è±Ô∏è Hourly Summary ‚Ä¢ ${new Date(timestamp).toLocaleString()}</div>
                    <div style="font-size: 1.1em; margin: 10px 0;">
                        <strong>${totalOperations} ${originalAction} operations</strong> at ${hourFormatted}
                    </div>
                    <div style="margin: 8px 0;">
                        üë§ Users: <strong>${users.length}</strong> ‚Ä¢ 
                        üìÅ Resources: <strong>${resources.length}</strong> ‚Ä¢ 
                        ‚ö° Rate: <strong>${activityRate} ops/min</strong> over ${activityDuration} min
                    </div>
                    <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.9;">
                        <button onclick="expandTimeBucket(this)" style="background: rgba(23,162,184,0.2); border: 1px solid rgba(23,162,184,0.3); color: #17a2b8; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">Show Details</button>
                    </div>
                    <div class="time-bucket-details" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(23,162,184,0.2);">
                        <div style="margin-bottom: 10px;">
                            <strong>Top Users:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                ${users.map(user => 
                                    `<div style="background: rgba(23,162,184,0.1); padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                                        ${user.username} (${user.count})
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Resources:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                ${resources.map(res => 
                                    `<div style="background: rgba(23,162,184,0.1); padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                                        ${res.name} (${res.count})
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        ${operationBreakdown && operationBreakdown.length > 0 ? `
                        <div>
                            <strong>Operation Types:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                ${operationBreakdown.map(op => 
                                    `<div style="background: rgba(23,162,184,0.1); padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                                        ${op.type} (${op.count})
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else if (bucketType === 'daily') {
                const { originalAction, dayFormatted, totalOperations, users, resources, hourlyDistribution } = data;
                
                // Create a simple bar chart for hourly distribution
                const maxCount = Math.max(...hourlyDistribution.map(h => h.count));
                const hourlyChart = hourlyDistribution.map(h => {
                    const percentage = Math.max(5, (h.count / maxCount) * 100);
                    return `
                        <div style="display: flex; align-items: center; margin: 2px 0;">
                            <div style="width: 30px; text-align: right; margin-right: 5px; font-size: 0.8em;">${h.hour}:00</div>
                            <div style="height: 12px; background: rgba(111,66,193,0.7); width: ${percentage}%; border-radius: 2px;"></div>
                            <div style="margin-left: 5px; font-size: 0.8em;">${h.count}</div>
                        </div>
                    `;
                }).join('');
                
                div.innerHTML = `
                    <div class="timestamp">üìÖ Daily Summary ‚Ä¢ ${new Date(timestamp).toLocaleString()}</div>
                    <div style="font-size: 1.1em; margin: 10px 0;">
                        <strong>${totalOperations} ${originalAction} operations</strong> on ${dayFormatted}
                    </div>
                    <div style="margin: 8px 0;">
                        üë§ Users: <strong>${users.length}</strong> ‚Ä¢ 
                        üìÅ Resources: <strong>${resources.length}</strong>
                    </div>
                    <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.9;">
                        <button onclick="expandTimeBucket(this)" style="background: rgba(111,66,193,0.2); border: 1px solid rgba(111,66,193,0.3); color: #6f42c1; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">Show Details</button>
                    </div>
                    <div class="time-bucket-details" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(111,66,193,0.2);">
                        <div style="margin-bottom: 15px;">
                            <strong>Hourly Distribution:</strong>
                            <div style="margin-top: 8px;">
                                ${hourlyChart}
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Top Users:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                ${users.map(user => 
                                    `<div style="background: rgba(111,66,193,0.1); padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                                        ${user.username} (${user.count})
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        <div>
                            <strong>Top Resources:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                ${resources.map(res => 
                                    `<div style="background: rgba(111,66,193,0.1); padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                                        ${res.name} (${res.count})
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.insertBefore(div, container.firstChild);
            
            // Keep only last 15 notifications
            while (container.children.length > 15) {
                container.removeChild(container.lastChild);
            }
            
            // Play a subtle notification sound
            playNotificationSound('medium');
        }
        
        function expandTimeBucket(buttonEl) {
            const details = buttonEl.parentElement.parentElement.querySelector('.time-bucket-details');
            if (details) {
                const isVisible = details.style.display !== 'none';
                details.style.display = isVisible ? 'none' : 'block';
                buttonEl.textContent = isVisible ? 'Show Details' : 'Hide Details';
            }
        }
        
        function displayIndividualNotification(notification) {
            // Use existing notification display logic but don't count it again
            const { action, data, timestamp, message } = notification;
            const priority = getPriority(action);
            
            const container = document.getElementById('notifications');
            const div = document.createElement('div');
            div.className = 'notification';
            
            // Add priority styling
            if (priority === 'critical') {
                div.style.borderLeft = '4px solid #dc3545';
                div.style.background = '#fff5f5';
            } else if (priority === 'high') {
                div.style.borderLeft = '4px solid #ffc107';
                div.style.background = '#fffbf0';
            }
            
            // Regular notification content
            div.innerHTML = `
                <div class="timestamp">${new Date(timestamp).toLocaleString()}</div>
                <div>
                    <span class="user">${data?.username || 'Unknown'}</span> 
                    performed <span class="action">${action || 'action'}</span> 
                    on <span class="resource">${data?.resource || 'resource'}</span>
                    ${data?.resourceId ? `(ID: ${data.resourceId})` : ''}
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    Role: ${data?.userRole || 'N/A'} | IP: ${data?.details?.ip || 'N/A'}
                </div>
                <div style="font-size: 0.9em; margin-top: 5px;">${message || 'No message'}</div>
            `;
            
            container.insertBefore(div, container.firstChild);
            
            // Keep only last 20 notifications
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }
        
        function renderHighActivity(notification) {
            const { data, timestamp } = notification;
            const list = document.getElementById('high-activity-list');
            const card = document.createElement('div');
            card.className = 'notification';
            card.style.borderLeft = '4px solid #ffc107';
            card.style.background = '#fffbf0';
            card.innerHTML = `
                <div class="timestamp">${new Date(timestamp).toLocaleString()}</div>
                <div style="font-size: 1.05em;">
                    <strong>‚ö†Ô∏è High Activity</strong> ‚Äî <span class="user">${data.username}</span>
                </div>
                <div style="margin-top: 6px;">
                    Total operations: <strong>${data.totalOperations}</strong>
                </div>
                <div style="margin-top: 6px; font-size: 0.9em; color: #555;">
                    ${Object.values(data.summary).map(s => `<div>‚Ä¢ ${s.count}√ó ${s.action} on ${s.resource}</div>`).join('')}
                </div>
            `;
            list.insertBefore(card, list.firstChild);
            while (list.children.length > 10) list.removeChild(list.lastChild);
        }

        function renderAggregate(notification) {
            const { data, timestamp } = notification;
            const list = document.getElementById('aggregates-list');
            const card = document.createElement('div');
            card.className = 'notification aggregated-notification';

            if (notification.action === 'time_bucket_daily') {
                // Handle daily time bucket notifications
                card.innerHTML = `
                    <div class="timestamp">üìÖ ${new Date(timestamp).toLocaleString()}</div>
                    <div style="font-size: 1.05em;">
                        <strong>Daily Summary: ${data.totalOperations} operations</strong>
                    </div>
                    <div style="margin-top: 6px;">
                        üë§ Users: <strong>${data.users.length}</strong> ‚Ä¢ 
                        üìÅ Resources: <strong>${data.resources.length}</strong>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.95em;">
                        <strong>Top Users:</strong>
                        ${data.users.slice(0, 5).map(user => 
                            `<div style="margin: 3px 0;">‚Ä¢ ${user.username}: ${user.count} operations</div>`
                        ).join('')}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.95em;">
                        <strong>Resources:</strong>
                        ${data.resources.slice(0, 5).map(res => 
                            `<div style="margin: 3px 0;">‚Ä¢ ${res.name}: ${res.count} operations</div>`
                        ).join('')}
                    </div>
                `;
            } else {
                // Handle regular aggregated notifications (server-side batches)
                card.innerHTML = `
                    <div class="timestamp">üìä ${new Date(timestamp).toLocaleString()}</div>
                    <div style="font-size: 1.05em;">
                        <strong>${data.totalOperations} ${data.originalAction} operations</strong> by <span class="user">${data.username}</span>
                    </div>
                    <div style="margin-top: 6px; font-size: 0.95em;">
                        Resource: <strong>${data.resource}</strong>
                        ${data.sampleResourceIds ? `<div style=\"margin-top:6px;font-size:0.85em;opacity:0.8;\">Sample IDs: ${data.sampleResourceIds.slice(0, 5).join(', ')}</div>` : ''}
                        <div style="margin-top:6px;font-size:0.85em;opacity:0.8;">Timeframe: ${data.timeframe || (Math.round((data.timeframeMs || 0)/1000) + 's')}</div>
                    </div>
                `;
            }

            list.insertBefore(card, list.firstChild);
            while (list.children.length > 15) list.removeChild(list.lastChild);
        }
    </script>
</body>
</html>
